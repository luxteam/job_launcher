<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="{{ pre_path }}/report_resources/css/bootstrap.css"/>
    <link rel="stylesheet" type="text/css" href="{{ pre_path }}/report_resources/css/bootstrap-table.css"/>
    <link rel="stylesheet" type="text/css" href="{{ pre_path }}/report_resources/css/style.css"/>
    <link rel="stylesheet" type="text/css" href="{{ pre_path }}/report_resources/css/test-statuses.css"/>

    <script src="{{ pre_path }}/report_resources/js/jquery-3.3.1.min.js" type="text/javascript"></script>
    <script src="{{ pre_path }}/report_resources/js/bootstrap.js" type="text/javascript"></script>
    <script src="{{ pre_path }}/report_resources/js/bootstrap-table.js" type="text/javascript"></script>
    <script src="{{ pre_path }}/report_resources/js/scripts.js" type="text/javascript"></script>
    <script src="{{ pre_path }}/report_resources/js/extensions/multiple-sort/bootstrap-table-multiple-sort.js"></script>
    <script src="{{ pre_path }}/report_resources/js/extensions/toolbar/bootstrap-table-toolbar.js"></script>

    <script src="{{ pre_path }}/report_resources/js/pixelmatch.js"></script>
    <script src="{{ pre_path }}/report_resources/js/images-substr.js"></script>
    <script src="{{ pre_path }}/report_resources/js/bootstrap-table-custom.js"></script>

    <title>{{ title }}</title>
</head>

<body>
    <a name="#top"/>
    <a id="goTop" href="#top" title="Go top"><span class="glyphicon glyphicon-arrow-up" aria-hidden="true" aria-label="Go top"></span></a>

    <div class="popup" id="imgsModal">
        <div class="popupContent" id="imgsModalContent">
            <form class="popupForm" oninput="currentThresholdView.value=parseFloat(thresholdRange.value)">
                <button class="commonButton closePopup" type="button" name="closePopupButton" onclick="closeModalWindow('imgsModal');return false;"><img src="{{ pre_path }}/report_resources/img/close-button.png"/></button>
                <button class="commonButton" type="button" name="increaseImgSizeButton" onclick="increaseImgSize();">Image Size +</button>
                <button class="commonButton" type="button" name="reduceImgSizeButton" onclick="reduceImgSize();">Image Size -</button>
                <button class="commonButton" type="button" name="showImgsSubstr" onclick="showImagesSubtraction('baselineImgPopup', 'renderedImgPopup');">Switch to difference</button>
                <input  autocomplete="true" id="thresholdRange" type="range"  name="thresholdSelector" min="0.0" max="1" step="0.01" value="0.03" oninput="renderCanvasData('baselineImgPopup', 'renderedImgPopup', this.value);"/>
                <output for="thresholdSelector">0.03</output>
            </form>
            <table class="baseTable" id="imgsCompareTable">
                <thead>
                    <tr>
                        <th>Baseline Image</th>
                        <th>Rendered Image</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="hatching"><img src="" id="baselineImgPopup"/></td>
                        <td class="hatching"><img src="" id="renderedImgPopup"/></td>
                    </tr>
                </tbody>
            </table>

            <table class="baseTable" id="imgsDiffTable" style="display: none">
            <thead>
                <tr>
                    <th>Difference Image</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td class="hatching" id="diffImageTd"><canvas id="imgsDifferenceCanvas"></canvas></td>
                </tr>
            </tbody>
            </table>
        </div>
    </div>

    <div id="infoBox"></div>

    <div id="header">
        <img src="{{ pre_path }}/report_resources/img/logo.png"/>

        <ul>
            <li><a id="summaryA" href='{{ pre_path }}/summary_report.html'>summary</a></li>
            <li><a id="performanceA" href='{{ pre_path }}/performance_report.html'>performance</a></li>
            <li><a id="compareA" href='{{ pre_path }}/compare_report.html'>compare</a></li>
        </ul>
    </div>

    <table class="baseTable">
        <tr>
            <th>Testing start</th>

            {% if report_type == 'ec' %}
            {# Core #}
            <th>Major version</th>
            <th>Minor version</th>
            {% else %}
            {# Default and converters #}
            <th>Plugin version</th>
            <th>Core version</th>
            {% endif %}
            
            <th>Branch name</th>
            <th>Commit SHA</th>
            <th>Commit message</th>
        </tr>
        <tr>
            <td>{{ common_info.reporting_date | env_override("JOB_STARTED_TIME") }}</td>

            {% if report_type == 'ec' %}
            {# Core #}
            <td>{{ common_info.core_version }}</td>
            <td>{{ common_info.minor_version }}</td>
            {% else %}
            {# Default and converters #}
            <td>{{ common_info.render_version }}</td>
            <td>{{ common_info.core_version }}</td>
            {% endif %}

            <td>{{ common_info.branch_name }}</td>
            <td>{{ common_info.commit_sha }}</td>
            <td>{{ common_info.commit_message }}</td>
        </tr>
    </table>

    <hr/>

    <div class="jsTableWrapper">
        <div id="toolbar">
            <button class="commonButton" type="button" name="showOnlyPassedCases" onclick="searchTextInBootstrapTable('passed');">Show passed [{{ render_report | selectattr("test_status", "equalto", "passed") | list | count }}]</button>
            <button class="commonButton" type="button" name="showOnlyFailedCases" onclick="searchTextInBootstrapTable('failed');">
                Show failed [{{ render_report | selectattr("test_status", "equalto", "failed") | list | count }}]
                <span class="glyphicon glyphicon-question-sign" aria-haspopup="true" aria-hidden="true"data-toggle="tooltip" data-placement="top"
                      title="Failed status means that pixel difference with baseline image is too large."></span>
            </button>
            <button class="commonButton" type="button" name="showOnlyErrorCases" onclick="searchTextInBootstrapTable('error');">
                Show error [{{ render_report | selectattr("test_status", "equalto", "error") | list | count }}]
                <span class="glyphicon glyphicon-question-sign" aria-haspopup="true" aria-hidden="true"data-toggle="tooltip" data-placement="top"
                      title="Error status means that fatal error has occur during testing."></span>
            </button>
            <button class="commonButton" type="button" name="showOnlySkippedCases" onclick="searchTextInBootstrapTable('skipped');">Show skipped [{{ render_report | selectattr("test_status", "equalto", "skipped") | list | count }}]</button>
            <button class="commonButton" type="button" name="showAll" onclick="searchTextInBootstrapTable('');">Reset</button>
        </div>

        <table class="baseTable localReportTable"
               id="local"
               data-toolbar="#toolbar"
               data-toggle="table"
               data-search="true"
               data-show-refresh="true"
               data-show-toggle="false"
               data-show-columns="true"
               data-show-pagination-switch="true"
               data-pagination="true"
               data-page-size="5"
               data-page-list="[1, 5, 10, 20, 45, ALL]"
               data-sort-order="asc"
               data-sort-name="test_status"
               data-show-multi-sort="true">

            <thead>
            <tr>
                <th data-field="test_case" data-halign="center" data-valign="middle" data-sortable="true" data-visible="false">Test case</th>
                <th data-field="test_case_copy" data-halign="center" data-valign="middle" data-sortable="true" data-events="copyTestCaseName">
                    Test case
                    <span class="glyphicon glyphicon-question-sign" aria-haspopup="true" aria-hidden="true"data-toggle="tooltip" data-placement="top" title="Button click copy direct test case link to clipboard"></span>
                </th>

                {# Baselines and results #}
                {% if report_type == 'default' or report_type == 'ec' %}
                <th data-field="baseline_img" data-halign="center" data-valign="middle" data-sortable="true" data-events="openFullImgSize" data-formatter="metaAJAX">Baseline Color</th>
                <th data-field="rendered_img" data-halign="center" data-valign="middle" data-sortable="true" data-events="openFullImgSize" data-formatter="metaAJAX">Rendered color</th>
                {% elif report_type == 'ct' %}
                <th data-field="original_img" data-halign="center" data-valign="middle" data-sortable="true" data-events="openFullImgSize" data-formatter="metaAJAX">{{ original_render | title }}</th>
                <th data-field="baseline_img" data-halign="center" data-valign="middle" data-sortable="true" data-events="openFullImgSize" data-formatter="metaAJAX">RPR Baseline</th>
                <th data-field="rendered_img" data-halign="center" data-valign="middle" data-sortable="true" data-events="openFullImgSize" data-formatter="metaAJAX">RPR</th>
                {% endif %}

                {% if report_type == 'default' or report_type == 'ec' %}
                <th data-filed="info" data-halign="center" data-valign="middle" data-sortable="true">Info</th>
                {% endif %}

                <th data-field="time_diff" 
                {% if report_type == 'default' %}
                    data-visible="true"
                {% elif report_type == 'ec' %}
                    data-visible="true"
                {% elif report_type == 'ct' %}
                    data-visible="true"
                {% endif %}
                data-halign="center" data-valign="middle" data-sortable="true">Render time diff, %</th>

                {# Other info #}
                {% if report_type == 'default' %}
                <th data-field="pix_diff_2" data-visible="true" data-halign="center" data-valign="middle" data-sortable="true">
                    Diff new
                    <span class="glyphicon glyphicon-question-sign" aria-haspopup="true" aria-hidden="true"data-toggle="tooltip" data-placement="top" title="[1] - diff images.
[0] - equals images.
[-1] - images has diff resolution, so couldn't be compared."></span>
                </th>
                {% elif report_type == 'ec' %}
                <th data-field="render_vram" data-visible="false" data-halign="center" data-valign="middle" data-sortable="true">Render GPU RAM, Mb</th>
                <th data-field="baseline_vram" data-visible="false" data-halign="center" data-valign="middle" data-sortable="true">Baseline GPU RAM, Mb</th>
                <th data-field="vram_diff" data-visible="true" data-halign="center" data-valign="middle" data-sortable="true">GPU RAM diff, %</th>
                <th data-field="pix_diff" data-visible="true" data-halign="center" data-valign="middle" data-sortable="true">Pixel diff, %</th>
                {% elif report_type == 'ct' %}
                <th data-field="pix_diff" data-visible="true" data-halign="center" data-valign="middle" data-sortable="true">Pixel diff, %</th>
                {% endif %}

                <th data-field="test_status"
                {% if report_type == 'default' %}
                    data-visible="false"
                {% elif report_type == 'ec' %}
                    data-visible="false"
                {% elif report_type == 'ct' %}
                    data-visible="true"
                {% endif %}
                data-halign="center" data-valign="middle" data-sortable="true">Test status
                    <span class="glyphicon glyphicon-question-sign" aria-haspopup="true" aria-hidden="true"data-toggle="tooltip" data-placement="top" title="[Failed] status means that pixel difference with baseline image is too large.
[Error] status means fatal error during render, terminating by timeout, or case wasn't launched at all.
[Skipped] status means case wasn't launched by QA team decision."></span>
                </th>

                {# Render time #}
                {% if report_type == 'default' or report_type == 'ec' %}
                <th data-field="render_time" 
                {% if report_type == 'default' %}
                    data-visible="false"
                {% elif report_type == 'ec' %}
                    data-visible="false"
                {% endif %}
                data-halign="center" data-valign="middle" data-sortable="true" data-formatter="timeFormatter">Render time</th>
                <th data-field="baseline_render_time"
                {% if report_type == 'default' %}
                    data-visible="false"
                {% elif report_type == 'ec' %}
                    data-visible="false"
                {% endif %}
                data-halign="center" data-valign="middle" data-sortable="true" data-formatter="timeFormatter">Baseline render time</th>
                {% elif report_type == 'ct' %}
                <th data-field="original_time" data-visible="true" data-halign="center" data-valign="middle" data-sortable="true" data-formatter="timeFormatter">{{ original_render | title }} render time</th>
                <th data-field="baseline_render_time" data-visible="true" data-halign="center" data-valign="middle" data-sortable="true" data-formatter="timeFormatter">Baseline render time</th>
                <th data-field="render_time" data-visible="true" data-halign="center" data-valign="middle" data-sortable="true" data-formatter="timeFormatter">RPR render time</th>
                {% endif %}

                <th data-filed="render_log"
                {% if report_type == 'default' %}
                    data-visible="true"
                {% elif report_type == 'ec' %}
                    data-visible="true"
                {% elif report_type == 'ct' %}
                    data-visible="true"
                {% endif %}
                data-halign="center" data-valign="middle">Log files</th>
            </tr>
            </thead>
            <tbody>
            {% for item in render_report %}
            <tr>
                <td>{{ item.test_case }}</td>
                <td><button class="commonButton" type="button" name="copyDirectLinkButton">{{ item.test_case }}</button></td>

                {# Baselines and results #}
                {% if report_type == 'default' or report_type == 'ec' %}
                <td class="hatching">
                {% if item.baseline_color_path %}
                    {% if 'thumb64_baseline_color_path' in item %}
                    <img data-src="{{ item.thumb64_baseline_color_path }}"/>
                    {% else %}
                    <img data-src="{{ item.baseline_color_path }}"/>
                    {% endif %}
                {% else %}
                    Not compared
                {% endif %}
                </td>
                <td class="hatching">
                    {% if 'thumb64_render_color_path' in item %}
                    <img data-src="{{ item.thumb64_render_color_path }}"/>
                    {% else %}
                    <img data-src="{{ item.render_color_path }}"/>
                    {% endif %}
                </td>
                {% elif report_type == 'ct' %}
                <td class="hatching">
                {% if item.original_color_path %}
                    {% if 'thumb64_original_color_path' in item %}
                    <img data-src="{{ item.thumb64_original_color_path }}"/>
                    {% else %}
                    <img data-src="{{ item.original_color_path }}"/>
                    {% endif %}
                {% else %}
                    Not compared
                {% endif %}
                </td>
                <td class="hatching">
                {% if item.baseline_color_path %}
                    {% if 'thumb64_baseline_color_path' in item %}
                    <img data-src="{{ item.thumb64_baseline_color_path }}"/>
                    {% else %}
                    <img data-src="{{ item.baseline_color_path }}"/>
                    {% endif %}
                {% else %}
                    Not compared
                {% endif %}
                </td>
                <td class="hatching">
                    {% if 'thumb64_render_color_path' in item %}
                    <img data-src="{{ item.thumb64_render_color_path }}"/>
                    {% else %}
                    <img data-src="{{ item.render_color_path }}"/>
                    {% endif %}
                </td>
                {% endif %}

                {% if report_type == 'default' or report_type == 'ec' %}
                <td class="infoColumn
                {%- if item.difference_time > 5 %}
                   {{ ' ' }}timeDiffFailedStatus
                {% endif -%} {{ ' ' }} {{ item.test_status }}Status">
                    <b>Scene:</b> {{ item.scene_name }}<br/>
                    <b>Render time:</b> {{ item.render_time | round(2) }}<br/>
                    <b>Baseline render time:</b> {{ item.baseline_render_time | round(2) }}<br/>
                    <b>Difference render time:</b> {{ item.difference_time | round(2) }} %<br/>
                    <b>Test info:</b><br/>
                    {% for param in item.script_info %}
                        {{ param }}<br/>
                    {% endfor %}
                </td>
                {% endif %}

                <!--TODO: 5% to conf CONSTS-->
                <td {%- if 5 < item.difference_time %}
                        class="timeWorseStatus"
                    {% elif item.difference_time < -5 %}
                        class="timeBetterStatus"
                    {% endif -%}
                    >
                    {{ item.difference_time | round (2) }}</td>

                {# Other info #}
                {% if report_type == 'default' %}
                <td class="{{ item.test_status }}Status">{{ item.difference_color_2 }}</td>
                {% elif report_type == 'ec' %}
                <td>{{ item.gpu_memory_usage }}</td>
                <td>{{ item.baseline_gpu_memory_usage }}</td>
                <!--TODO: 5% to conf CONSTS-->
                <td {%- if 5 < item.difference_vram %}
                        class="timeWorseStatus"
                    {% elif item.difference_vram < -5 %}
                        class="timeBetterStatus"
                    {% endif -%}
                    >
                    {{ item.difference_vram }}</td>
                <td class="{{ item.test_status }}Status">{{ item.difference_color }}</td>
                {% elif report_type == 'ct' %}
                <td class="{{ item.test_status }}Status">{{ item.difference_color }}</td>
                {% endif %}

                <td class="{{ item.test_status }}Status">{{ item.test_status | title }}</td>

                {# Render time #}
                {% if report_type == 'default' or report_type == 'ec' %}
                <td>{{ item.render_time | round(2) }}</td>
                <td>{{ item.baseline_render_time | round(2) }}</td>
                {% elif report_type == 'ct' %}
                <td>{{ item.or_render_time }}</td>
                <td>{{ item.baseline_render_time }}</td>
                <td>{{ item.render_time }}</td>
                {% endif %}

                {# Log files #}
                {% if report_type == 'default' %}
                <td>
                    {%- if 'render_log' in item %}
                    <a href="{{ item.render_log }}">Render log</a>
                    {% else %}
                    <a href="{{ report[i].results[test_package][test_conf].result_path }}/renderTool.log">Render Log</a>
                    {% endif -%}
                </td>
                {% elif report_type == 'ec' %}
                <td>
                    <a href="{{ report[i].results[test_package][test_conf].result_path }}/tahoe.log">tahoe Log</a>
                </td>
                {% elif report_type == 'ct' %}
                <td>
                    <!--TODO: get render path from json-->
                    <a href="{{ report[i].results[test_package][test_conf].result_path }}/{{ item.original_render_log }}">{{ original_render | title }} log</a><br/>
                    <a href="{{ report[i].results[test_package][test_conf].result_path }}/{{ item.scene_name }}.conversion.log">Conversion log</a><br/>
                    <a href="{{ report[i].results[test_package][test_conf].result_path }}/renderTool.log">RPR Log</a>
                </td>
                {% endif %}

            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

    <hr>

    <div id="footer">
        Luxoft RPR CIS
        <br>
        2017-2019
        <br>
        jobs_launcher v{{ "v" | get_jobs_launcher_version() }}
    </div>

</body>
</html>